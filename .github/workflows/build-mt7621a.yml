name: Build MT7621a IPK (Debug Mode)

on: [workflow_dispatch]

env:
  SDK_URL: https://downloads.openwrt.org/releases/22.03.3/targets/ramips/mt7621/openwrt-sdk-22.03.3-ramips-mt7621_gcc-11.2.0_musl.Linux-x86_64.tar.xz

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4

    - name: Install essentials
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev zlib1g-dev python3

    - name: Download SDK
      run: |
        wget -T 60 ${{ env.SDK_URL }} -O sdk.tar.xz
        [ $(stat -c%s sdk.tar.xz) -gt 100000000 ] || exit 1

    - name: Extract SDK
      run: |
        tar -xvf sdk.tar.xz
        mv openwrt-sdk-* sdk
        echo "SDK_PATH=$(pwd)/sdk" >> $GITHUB_ENV

    - name: Setup environment
      run: |
        echo "STAGING_DIR=${{ env.SDK_PATH }}/staging_dir" >> $GITHUB_ENV
        echo "PATH=${{ env.SDK_PATH }}/staging_dir/toolchain-mipsel_24kc_gcc-11.2.0_musl/bin:$PATH" >> $GITHUB_ENV

    - name: Verify toolchain
      run: |
        mipsel-openwrt-linux-gcc -v
        mipsel-openwrt-linux-gcc -print-search-dirs

- name: Prepare package
  run: |
    # 1. 创建目标目录
    mkdir -p ${{ env.SDK_PATH }}/package/qmodem
    
    # 2. 使用find+cpio安全复制（自动排除sdk）
    cd $GITHUB_WORKSPACE
    find . -maxdepth 1 -not -name '.' -not -name 'sdk' -print0 | \
      cpio -pmd0 ${{ env.SDK_PATH }}/package/qmodem/
    
    # 3. 验证复制结果
    echo "=== 复制后的文件结构 ==="
    ls -l ${{ env.SDK_PATH }}/package/qmodem/
    
    # 4. 必须存在的文件检查
    [ -f "${{ env.SDK_PATH }}/package/qmodem/Makefile" ] || {
      echo "❌ Makefile缺失！";
      exit 1;
    }

    - name: Compile with debug
      run: |
        cd ${{ env.SDK_PATH }}
        make defconfig
        echo "CONFIG_PACKAGE_qmodem=y" >> .config
        make package/qmodem/compile V=sc 2>&1 | tee compile.log
        grep -i "error" compile.log && exit 1

    - name: Upload artifacts
      if: ${{ success() }}
      uses: actions/upload-artifact@v4
      with:
        name: output
        path: |
          ${{ env.SDK_PATH }}/bin/packages/*/*.ipk
          ${{ env.SDK_PATH }}/compile.log

    - name: Upload debug info
      if: ${{ failure() }}
      uses: actions/upload-artifact@v4
      with:
        name: debug-info
        path: |
          ${{ env.SDK_PATH }}/.config
          ${{ env.SDK_PATH }}/compile.log
          ${{ env.SDK_PATH }}/tmp/pkg/qmodem/
